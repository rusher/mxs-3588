const mariadb = require('mariadb');
const tt = '{"timestamp":1623274670126,"webhookEvent":"jira:issue_updated","issue_event_type_name":"issue_updated","user":{"self":"https://jira.mariadb.org/rest/api/2/user?username=paul.moen","name":"paul.moen","key":"paul.moen","emailAddress":"paul.moen@mariadb.com","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?avatarId=10122","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&avatarId=10122","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&avatarId=10122","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&avatarId=10122"},"displayName":"Paul Moen","active":true,"timeZone":"Australia/Sydney"},"issue":{"id":"100122","self":"https://jira.mariadb.org/rest/api/2/issue/100122","key":"MENT-1207","fields":{"issuetype":{"self":"https://jira.mariadb.org/rest/api/2/issuetype/1","id":"1","description":"A problem which impairs or prevents the functions of the product.","iconUrl":"https://jira.mariadb.org/secure/viewavatar?size=xsmall&avatarId=14103&avatarType=issuetype","name":"Bug","subtask":false,"avatarId":14103},"timespent":null,"project":{"self":"https://jira.mariadb.org/rest/api/2/project/11500","id":"11500","key":"MENT","name":"MariaDB Enterprise","projectTypeKey":"software","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/projectavatar?avatarId=17303","24x24":"https://jira.mariadb.org/secure/projectavatar?size=small&avatarId=17303","16x16":"https://jira.mariadb.org/secure/projectavatar?size=xsmall&avatarId=17303","32x32":"https://jira.mariadb.org/secure/projectavatar?size=medium&avatarId=17303"},"projectCategory":{"self":"https://jira.mariadb.org/rest/api/2/projectCategory/10100","id":"10100","description":"MariaDB Server related projects","name":"Server"}},"fixVersions":[{"self":"https://jira.mariadb.org/rest/api/2/version/23604","id":"23604","description":"","name":"10.4","archived":false,"released":false}],"aggregatetimespent":null,"resolution":null,"customfield_10700":"1|i00yjb:","customfield_10109":null,"resolutiondate":null,"workratio":-1,"lastViewed":"2021-06-09T21:36:31.506+0000","watches":{"self":"https://jira.mariadb.org/rest/api/2/issue/MENT-1207/watchers","watchCount":4,"isWatching":true},"created":"2021-05-28T16:59:52.000+0000","priority":{"self":"https://jira.mariadb.org/rest/api/2/priority/3","iconUrl":"https://jira.mariadb.org/images/icons/priorities/major.svg","name":"Major","id":"3"},"customfield_10300":"9223372036854775807","customfield_10102":null,"labels":["crash","galera"],"customfield_10103":null,"customfield_11700":"{summaryBean=com.atlassian.jira.plugin.devstatus.rest.SummaryBean@34f82d10[summary={pullrequest=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@1b0b473[overall=PullRequestOverallBean{stateCount=0, state=\'OPEN\', details=PullRequestOverallDetails{openCount=0, mergedCount=0, declinedCount=0}},byInstanceType={}], build=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@24ccc1ff[overall=com.atlassian.jira.plugin.devstatus.summary.beans.BuildOverallBean@205bea39[failedBuildCount=0,successfulBuildCount=0,unknownBuildCount=0,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], review=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@1295db01[overall=com.atlassian.jira.plugin.devstatus.summary.beans.ReviewsOverallBean@c111dea[stateCount=0,state=<null>,dueDate=<null>,overDue=false,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], deployment-environment=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@4e10f6ae[overall=com.atlassian.jira.plugin.devstatus.summary.beans.DeploymentOverallBean@31e5d777[topEnvironments=[],showProjects=false,successfulCount=0,count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], repository=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@d145f99[overall=com.atlassian.jira.plugin.devstatus.summary.beans.CommitOverallBean@9eeed9c[count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}], branch=com.atlassian.jira.plugin.devstatus.rest.SummaryItemBean@4082cf89[overall=com.atlassian.jira.plugin.devstatus.summary.beans.BranchOverallBean@5f43e681[count=0,lastUpdated=<null>,lastUpdatedTimestamp=<null>],byInstanceType={}]},errors=[],configErrors=[]], devSummaryJson={\\"cachedValue\\":{\\"errors\\":[],\\"configErrors\\":[],\\"summary\\":{\\"pullrequest\\":{\\"overall\\":{\\"count\\":0,\\"lastUpdated\\":null,\\"stateCount\\":0,\\"state\\":\\"OPEN\\",\\"details\\":{\\"openCount\\":0,\\"mergedCount\\":0,\\"declinedCount\\":0,\\"total\\":0},\\"open\\":true},\\"byInstanceType\\":{}},\\"build\\":{\\"overall\\":{\\"count\\":0,\\"lastUpdated\\":null,\\"failedBuildCount\\":0,\\"successfulBuildCount\\":0,\\"unknownBuildCount\\":0},\\"byInstanceType\\":{}},\\"review\\":{\\"overall\\":{\\"count\\":0,\\"lastUpdated\\":null,\\"stateCount\\":0,\\"state\\":null,\\"dueDate\\":null,\\"overDue\\":false,\\"completed\\":false},\\"byInstanceType\\":{}},\\"deployment-environment\\":{\\"overall\\":{\\"count\\":0,\\"lastUpdated\\":null,\\"topEnvironments\\":[],\\"showProjects\\":false,\\"successfulCount\\":0},\\"byInstanceType\\":{}},\\"repository\\":{\\"overall\\":{\\"count\\":0,\\"lastUpdated\\":null},\\"byInstanceType\\":{}},\\"branch\\":{\\"overall\\":{\\"count\\":0,\\"lastUpdated\\":null},\\"byInstanceType\\":{}}}},\\"isStale\\":false}}","timeestimate":null,"aggregatetimeoriginalestimate":null,"versions":[{"self":"https://jira.mariadb.org/rest/api/2/version/25010","id":"25010","description":"Release date is the internal release, code freeze 2/MAR/21","name":"10.4.18-11","archived":false,"released":true,"releaseDate":"2021-03-15"}],"issuelinks":[],"assignee":{"self":"https://jira.mariadb.org/rest/api/2/user?username=jplindst","name":"jplindst","key":"jplindst","emailAddress":"jan@mariadb.com","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?ownerId=jplindst&avatarId=16206","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&ownerId=jplindst&avatarId=16206","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&ownerId=jplindst&avatarId=16206","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&ownerId=jplindst&avatarId=16206"},"displayName":"Jan LindstrÃ¶m","active":true,"timeZone":"Europe/Helsinki"},"updated":"2021-06-09T21:37:50.000+0000","status":{"self":"https://jira.mariadb.org/rest/api/2/status/1","description":"","iconUrl":"https://jira.mariadb.org/images/icons/statuses/open.png","name":"Open","id":"1","statusCategory":{"self":"https://jira.mariadb.org/rest/api/2/statuscategory/2","id":2,"key":"new","colorName":"blue-gray","name":"To Do"}},"components":[{"self":"https://jira.mariadb.org/rest/api/2/component/14918","id":"14918","name":"Galera","description":"the galera library (libgalera_smm.so)"}],"timeoriginalestimate":null,"description":"Galera node is crashing with signal 11:\\r\\n\\t\\t\\t\\t\\t\\t\\t\\r\\nstack_bottom = 0x7fa8edca6cf0 thread_stack 0x49000\\r\\n/usr/sbin/mysqld(my_print_stacktrace+0x2e)[0x560e6c7a6fee]\\r\\n/usr/sbin/mysqld(handle_fatal_signal+0x30f)[0x560e6c22436f]\\r\\n/lib64/libpthread.so.0(+0xf630)[0x7fb91e06f630]\\r\\n/usr/sbin/mysqld(+0xcf9745)[0x560e6c64c745]\\r\\n/usr/sbin/mysqld(_Z15end_read_recordP11READ_RECORD+0x6a)[0x560e6c35ae0a]\\r\\n/usr/sbin/mysqld(_ZN13st_join_table7cleanupEv+0x20f)[0x560e6c04a02f]\\r\\n/usr/sbin/mysqld(_ZN4JOIN7cleanupEb+0x368)[0x560e6c054688]\\r\\n/usr/sbin/mysqld(_ZN4JOIN9join_freeEv+0x4c)[0x560e6c054adc]\\r\\n/usr/sbin/mysqld(_ZN4JOIN10exec_innerEv+0xc20)[0x560e6c072620]\\r\\n/usr/sbin/mysqld(_ZN4JOIN4execEv+0x33)[0x560e6c0728a3]\\r\\n/usr/sbin/mysqld(_Z12mysql_selectP3THDP10TABLE_LISTjR4ListI4ItemEPS4_jP8st_orderS9_S7_S9_yP13select_resultP18st_select_lex_unitP13st_select_lex+0x186)[0x560e6c070ad6]\\r\\n/usr/sbin/mysqld(_Z13handle_selectP3THDP3LEXP13select_resultm+0x1e7)[0x560e6c071657]\\r\\n/usr/sbin/mysqld(+0x5b107b)[0x560e6bf0407b]\\r\\n/usr/sbin/mysqld(_Z21mysql_execute_commandP3THD+0x3970)[0x560e6c015680]\\r\\n/usr/sbin/mysqld(_Z11mysql_parseP3THDPcjP12Parser_statebb+0x1fb)[0x560e6c01abbb]\\r\\n/usr/sbin/mysqld(+0x5b1268)[0x560e6bf04268]\\r\\n/usr/sbin/mysqld(_Z16dispatch_command19enum_server_commandP3THDPcjbb+0x2969)[0x560e6c01dd59]\\r\\n/usr/sbin/mysqld(_Z10do_commandP3THD+0x112)[0x560e6c01e362]\\r\\n/usr/sbin/mysqld(_Z24do_handle_one_connectionP7CONNECT+0x221)[0x560e6c101a01]\\r\\n/usr/sbin/mysqld(handle_one_connection+0x3d)[0x560e6c101abd]\\r\\n/lib64/libpthread.so.0(+0x7ea5)[0x7fb91e067ea5]\\r\\n/lib64/libc.so.6(clone+0x6d)[0x7fb91c19d9fd]\\r\\n","customfield_11300":"0.0","customfield_11301":null,"customfield_11500":["CS0306228","CS0311887","CS0314735"],"timetracking":{},"customfield_10600":null,"attachment":[{"self":"https://jira.mariadb.org/rest/api/2/attachment/57904","id":"57904","filename":"full_error.txt","author":{"self":"https://jira.mariadb.org/rest/api/2/user?username=Bongini","name":"Bongini","key":"bongini","emailAddress":"luigi.bongini@mariadb.com","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?avatarId=10122","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&avatarId=10122","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&avatarId=10122","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&avatarId=10122"},"displayName":"Luigi","active":true,"timeZone":"Europe/Rome"},"created":"2021-05-28T17:13:45.000+0000","size":12690,"mimeType":"text/plain","content":"https://jira.mariadb.org/secure/attachment/57904/full_error.txt"},{"self":"https://jira.mariadb.org/rest/api/2/attachment/57999","id":"57999","filename":"vergent crash error log June 9 2021.txt","author":{"self":"https://jira.mariadb.org/rest/api/2/user?username=lksmith","name":"lksmith","key":"JIRAUSER48490","emailAddress":"lisa.smith@mariadb.com","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?avatarId=10122","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&avatarId=10122","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&avatarId=10122","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&avatarId=10122"},"displayName":"Lisa Smith","active":true,"timeZone":"America/Denver"},"created":"2021-06-09T15:51:44.000+0000","size":7392,"mimeType":"text/plain","content":"https://jira.mariadb.org/secure/attachment/57999/vergent+crash+error+log+June+9+2021.txt"}],"aggregatetimeestimate":null,"summary":"MariaDB 10.4.18-11-MariaDB-enterprise Galera node crashing with signal 11","creator":{"self":"https://jira.mariadb.org/rest/api/2/user?username=Bongini","name":"Bongini","key":"bongini","emailAddress":"luigi.bongini@mariadb.com","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?avatarId=10122","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&avatarId=10122","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&avatarId=10122","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&avatarId=10122"},"displayName":"Luigi","active":true,"timeZone":"Europe/Rome"},"subtasks":[],"reporter":{"self":"https://jira.mariadb.org/rest/api/2/user?username=Bongini","name":"Bongini","key":"bongini","emailAddress":"luigi.bongini@mariadb.com","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?avatarId=10122","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&avatarId=10122","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&avatarId=10122","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&avatarId=10122"},"displayName":"Luigi","active":true,"timeZone":"Europe/Rome"},"customfield_10000":"9223372036854775807","aggregateprogress":{"progress":0,"total":0},"customfield_10400":null,"customfield_11601":null,"customfield_11403":null,"customfield_11600":null,"environment":"CentOS Linux release 7.9.2009 (Core)\\r\\nKernel 3.10.0-1062.9.1.el7.x86_64","customfield_11404":null,"customfield_11602":null,"duedate":null,"progress":{"progress":0,"total":0},"comment":{"comments":[{"self":"https://jira.mariadb.org/rest/api/2/issue/100122/comment/191555","id":"191555","author":{"self":"https://jira.mariadb.org/rest/api/2/user?username=lksmith","name":"lksmith","key":"JIRAUSER48490","emailAddress":"lisa.smith@mariadb.com","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?avatarId=10122","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&avatarId=10122","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&avatarId=10122","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&avatarId=10122"},"displayName":"Lisa Smith","active":true,"timeZone":"America/Denver"},"body":"We have another galera node crash of the same version 10.4.18.\\r\\nAttached is the error log and the core file is available. [^vergent crash error log June 9 2021.txt] \\r\\nThank you","updateAuthor":{"self":"https://jira.mariadb.org/rest/api/2/user?username=lksmith","name":"lksmith","key":"JIRAUSER48490","emailAddress":"lisa.smith@mariadb.com","avatarUrls":{"48x48":"https://jira.mariadb.org/secure/useravatar?avatarId=10122","24x24":"https://jira.mariadb.org/secure/useravatar?size=small&avatarId=10122","16x16":"https://jira.mariadb.org/secure/useravatar?size=xsmall&avatarId=10122","32x32":"https://jira.mariadb.org/secure/useravatar?size=medium&avatarId=10122"},"displayName":"Lisa Smith","active":true,"timeZone":"America/Denver"},"created":"2021-06-09T15:51:54.000+0000","updated":"2021-06-09T15:51:54.000+0000"}],"maxResults":1,"total":1,"startAt":0},"votes":{"self":"https://jira.mariadb.org/rest/api/2/issue/MENT-1207/votes","votes":2,"hasVoted":true},"worklog":{"startAt":0,"maxResults":20,"total":0,"worklogs":[]}}},"changelog":{"id":"520932","items":[{"field":"Support case ID","fieldtype":"custom","from":null,"fromString":"CS0311887 CS0314735","to":null,"toString":"CS0311887 CS0314735 CS0306228"}]}}';
const tt2 = JSON.parse(tt);

// max_allowed_packet must be >= 16M
const test = async function() {
  const conn = await mariadb.createConnection({
    user: 'boby',
    password: 'heyPassw0-rd',
    database: 'testj',
    host: 'localhost',
    connectTimeout: 1000,
    port: 4006,
    maxAllowedPacket: 16 * 1024 * 1024,
    debug: true
  });

  await conn.query('DROP TABLE IF EXISTS bigBatchWith16mMaxAllowedPacket');
  await conn.query(
    'CREATE TABLE bigBatchWith16mMaxAllowedPacket(id int, id2 int, id3 int, t varchar(128), id4 int) CHARSET utf8mb4'
  );
  await conn.query('FLUSH TABLES');
  await conn.query('START TRANSACTION');

  const str = "abcdefghijkflmn'opqrtuvwx🤘💪";
  const values = [];
  for (let i = 0; i < 1000000; i++) {
    values.push([i, str]);
  }

  let res = await conn.batch(
    'INSERT INTO `bigBatchWith16mMaxAllowedPacket` values (1, ?, 2, ?, 3)',
    values
  );
  assert.equal(res.affectedRows, 1000000);

  await conn.query('ROLLBACK');
  conn.end();
}

test();